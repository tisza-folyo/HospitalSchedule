<div class="container-fluid py-4">
    <h2 class="mb-4 text-primary fw-bold text-center">Asszisztens Vezérlőpult</h2>

    <ul class="nav nav-pills nav-fill mb-4 shadow-sm p-2 bg-white rounded border" id="doctorTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active py-3" id="patients-tab" data-bs-toggle="tab" data-bs-target="#patients"
                type="button" (click)="navigateToPatient()">
                <i class="bi bi-people-fill me-2"></i>Betegek Adatai
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link py-3" id="appointments-tab" data-bs-toggle="tab" data-bs-target="#appointments"
                type="button" (click)="navigateToAppoints()">
                <i class="bi bi-calendar-check me-2"></i>Betegek Időpontjai
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link py-3" id="schedule-tab" data-bs-toggle="tab" data-bs-target="#schedule"
                type="button" (click)="navigatToSchedule()">
                <i class="bi bi-clock-history me-2"></i>Munkabeosztás
            </button>
        </li>
    </ul>

    <div class="tab-content" id="assistantTabContent">

        <div class="tab-pane fade show active text-center" id="patients" role="tabpanel">
            <div class="row g-3">
                <div class="col-lg-4">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-header bg-primary text-white fw-bold">Beteg Kereső</div>
                        <div class="card-body">
                            <input type="text" class="form-control mb-3" placeholder="Név vagy TAJ szám alapján..."
                                [(ngModel)]="filter" (input)="filterPatients()">
                            <div class="list-group overflow-auto" style="max-height: 500px;">
                                @for (p of filteredPatients; track p.taj) {
                                <button class="list-group-item list-group-item-action text-start"
                                    [class.active]="patient === p" (click)="selectPatient(p,false)">
                                    <h6 class="mb-1 fw-bold">{{p.firstName}} {{p.lastName}}</h6>
                                    <small [class.text-white]="patient === p" [class.text-muted]="patient !== p">
                                        TAJ: {{p.taj}}
                                    </small>
                                </button>
                                }
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-8">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-header bg-primary text-white">Beteg Részletes Adatai</div>
                        <div class="card-body text-start">
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <p><strong>Név:</strong> {{patient?.firstName}} {{patient?.lastName}}</p>
                                    <p><strong>Életkor:</strong> {{patient?.age}}</p>
                                </div>
                                <div class="col-md-6 text-md-end">
                                    <p><strong>TAJ:</strong> {{patient?.taj}}</p>
                                    <p><strong>Emal:</strong> {{patient?.email}}</p>
                                </div>
                            </div>
                            <hr>
                            <h6 class="fw-bold mb-3">Feltöltött Dokumentumok</h6>
                            <div class="document-container border p-3 rounded bg-light">
                                @for (file of patient?.personalDocImages; track file.dwnUrl) {
                                <div class="file-item mb-4 pb-3 border-bottom">

                                    @if (file.fileType === 'application/pdf') {
                                    <div class="pdf-box p-3 border rounded bg-light text-center">
                                        <button class="btn btn-sm btn-outline-secondary"
                                            (click)="this.appService.downloadPdf(file)">

                                            <i class="bi bi-file-earmark"></i> {{ file.fileName }}
                                        </button>
                                    </div>
                                    }
                                    @else if (file.fileType.includes('image')) {
                                    <div class="image-viewer text-center">
                                        <button
                                            class="btn btn-sm btn-outline-secondary shadow-sm d-flex align-items-center gap-2"
                                            (click)="this.appService.downloadPdf(file)" [title]="file.fileName">

                                            <img [src]="'data:' + file.fileType + ';base64,' + file.base64Data"
                                                class="rounded border bg-white"
                                                style="height: 24px; width: 24px; object-fit: cover;">

                                            <span class="text-truncate" style="max-width: 150px;">
                                                <i class="bi bi-image me-1"></i> {{ file.fileName }}
                                            </span>
                                        </button>
                                    </div>
                                    }
                                    @else {
                                    <div class="alert alert-info d-flex align-items-center">
                                        <i class="bi bi-info-circle-fill me-2"></i>
                                        <div>
                                            <strong>{{ file.fileName }}</strong> ({{ file.fileType }})
                                            nem jeleníthető meg közvetlenül.
                                            <br>
                                            <a [href]="file.dwnUrl" target="_blank" class="btn btn-sm btn-primary mt-2">
                                                Fájl megnyitása / Letöltése
                                            </a>
                                        </div>
                                    </div>
                                    }

                                </div>
                                } @empty {
                                <div class="text-center py-4 text-muted">
                                    <i class="bi bi-files fs-1 d-block mb-2"></i>
                                    <p>Ehhez az pácienshez nem tartoznak csatolt fájlok.</p>
                                </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="appointments" role="tabpanel">
            <div class="row g-3">
                <div class="col-lg-4">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-header bg-primary text-white fw-bold">Páciens választása</div>
                        <div class="card-body">
                            <input type="text" class="form-control mb-3" placeholder="Név vagy TAJ..."
                                [(ngModel)]="filter" (input)="filterPatients()">
                            @if (patient !== null && !isBookingMode) {
                            <div class="d-grid mb-3 animate__animated animate__fadeIn">
                                <button class="btn btn-success fw-bold shadow-sm" (click)="switchToBooking()">
                                    <i class="bi bi-calendar-plus me-2"></i>Időpont felvétele
                                </button>
                            </div>
                            }@else if(isBookingMode){
                            <div class="d-grid mb-3 animate__animated animate__fadeIn">
                                <button class="btn btn-success fw-bold shadow-sm" (click)="switchToBooking()">
                                    <i class="bi bi-calendar-plus me-2"></i>Vissza a páciensekhez
                                </button>
                            </div>
                            }@else{
                            <div class="d-grid mb-3 animate__animated animate__fadeIn">
                                <button class="btn btn-success fw-bold shadow-sm" disabled>
                                    <i class="bi bi-calendar-plus me-2"></i>Időpont felvétele
                                </button>
                            </div>
                            }
                            <div class="list-group overflow-auto" style="max-height: 600px;">
                                @for (p of filteredPatients; track p.taj) {
                                <button class="list-group-item list-group-item-action text-start"
                                    [class.active]="patient === p" (click)="selectPatient(p,true)">
                                    <h6 class="mb-1 fw-bold">{{p.firstName}} {{p.lastName}}</h6>
                                    <small [class.text-white]="patient === p">TAJ: {{p.taj}}</small>
                                </button>
                                }
                            </div>
                        </div>
                    </div>
                </div>
                @if (!isBookingMode) {
                <div class="col-lg-8">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-header bg-primary text-white fw-bold">
                            {{ patient ? patient.lastName + ' időpontjai' : 'Válasszon pácienst!' }}
                        </div>
                        <div class="card-body p-0">
                            <div class="list-group list-group-flush">
                                @for (a of appoints; track a.timeSlot) {
                                <div class="list-group-item">
                                    <div class="d-flex justify-content-between align-items-center p-3 cursor-pointer border-bottom"
                                        (click)="selectAppo(a)" style="cursor: pointer;">

                                        <div class="d-flex align-items-center">
                                            <span class="text-muted">
                                                <strong class="text-dark">Doktor TAJ:</strong> {{a.doctorTaj}}
                                            </span>
                                        </div>

                                        <div class="d-flex align-items-center gap-3">
                                            <span class="badge bg-info px-3 py-2 fs-6 shadow-sm">
                                                <i class="bi bi-calendar3 me-1"></i>
                                                {{ a.timeSlot.toISOString().split('T')[0] }}
                                            </span>

                                            <span class="badge px-3 py-2 fs-6 shadow-sm"
                                                [ngClass]="'bg-' + appService.stausColorConverter(a.status)">
                                                {{ this.appService.statusConverter(a.status) }}
                                            </span>

                                            <i class="bi ms-2 fs-5 text-secondary"
                                                [class.bi-chevron-down]="appoId !== a.appointmentId"
                                                [class.bi-chevron-up]="appoId === a.appointmentId">
                                            </i>
                                        </div>
                                    </div>

                                    @if (appoId === a.appointmentId) {
                                    <div class="p-3 bg-light border-top mt-2 animate__animated animate__fadeIn">
                                        <div class="row">
                                            <div class="col-12 mb-3">
                                                <label class="fw-bold small text-muted d-block">Leírás / Panasz:</label>
                                                <p class="mb-0">{{ a.description || 'Nincs megadva leírás.' }}</p>
                                            </div>
                                            <div class="col-12">
                                                <div class="d-flex justify-content-between align-items-end mb-2">
                                                    <label class="fw-bold small text-muted d-block mb-2">Csatolt
                                                        fájlok:</label>
                                                    <button class="btn btn-primary btn-sm shadow-sm"
                                                        (click)="updateFile(a)">
                                                        <i class="bi bi-plus-circle me-1"></i> Új feltöltés
                                                    </button>
                                                </div>
                                                <div class="d-flex flex-wrap gap-2">
                                                    @for (file of a.files; track file.dwnUrl) {
                                                    @if (file.fileType === 'application/pdf') {
                                                    <button class="btn btn-sm btn-outline-secondary"
                                                        (click)="this.appService.downloadPdf(file)">

                                                        <i class="bi bi-file-earmark"></i> {{ file.fileName }}


                                                    </button>}@else if (file.fileType.includes('image')) {
                                                    <button
                                                        class="btn btn-sm btn-outline-secondary shadow-sm d-flex align-items-center gap-2"
                                                        (click)="this.appService.downloadPdf(file)"
                                                        [title]="file.fileName">

                                                        <img [src]="'data:' + file.fileType + ';base64,' + file.base64Data"
                                                            class="rounded border bg-white"
                                                            style="height: 24px; width: 24px; object-fit: cover;">

                                                        <span class="text-truncate" style="max-width: 150px;">
                                                            <i class="bi bi-image me-1"></i> {{ file.fileName }}
                                                        </span>
                                                    </button>
                                                    }

                                                    @else {
                                                    <button class="btn btn-sm btn-light border"
                                                        (click)="this.appService.downloadPdf(file)">
                                                        <i class="bi bi-file-earmark"></i> {{ file.fileName }}
                                                    </button>
                                                    }
                                                    } @empty {
                                                    <span class="text-muted small italic">Nincsenek fájlok.</span>
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    }
                                </div>
                                } @empty {
                                <div class="text-center py-5 text-muted">
                                    <i class="bi bi-calendar2-x fs-1 d-block mb-2"></i>
                                    <p>Nincsenek rögzített időpontok.</p>
                                </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
                }@else{
                <div class="col-lg-8">
                    <div class="row g-4 animate__animated animate__fadeIn">
                        <div class="col-lg-5">
                            <div class="card shadow-sm border-0">
                                <div class="card-header bg-success text-white fw-bold">Szűrési feltételek</div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label fw-bold small">Dátum kiválasztása</label>
                                        <div class="d-flex gap-1">
                                            <input type="date" class="form-control" [(ngModel)]="date" [min]="today"
                                                (change)="missingDate = false">
                                            <button class="btn btn-outline-danger" (click)="resetField('book')"><i
                                                    class="bi bi-x-lg"></i>
                                                <svg xmlns="http://www.w3.org/2000/svg" height="24px"
                                                    viewBox="0 -960 960 960" width="24px" fill="currentColor">
                                                    <path
                                                        d="M480-160q-134 0-227-93t-93-227q0-134 93-227t227-93q69 0 132 28.5T720-690v-110h80v280H520v-80h168q-32-56-87.5-88T480-720q-100 0-170 70t-70 170q0 100 70 170t170 70q77 0 139-44t87-116h84q-28 106-114 173t-196 67Z" />
                                                </svg>
                                            </button>
                                        </div>
                                        @if (missingDate) { <div class="text-danger small mt-1">Kérjük, válasszon
                                            dátumot!</div> }
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-bold small">Szekció</label>
                                        <select class="form-select" [(ngModel)]="section" [disabled]="doctor !== null">
                                            <option selected hidden value="">Összes szekció</option>
                                            @for (sec of sections; track sec) { <option [value]="sec">{{ sec }}</option>
                                            }
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-bold small">Orvos</label>
                                        <select class="form-select" [(ngModel)]="doctor" [disabled]="section !== ''">
                                            <option selected hidden value="null">Bármely orvos</option>
                                            @for (doc of doctors; track doc) { <option [ngValue]="doc">{{ doc.lastName
                                                }} {{ doc.firstName }}</option> }
                                        </select>
                                    </div>
                                    <div class="d-grid mt-4">
                                        <button class="btn btn-primary fw-bold" (click)="searchAppointments()">
                                            <i class="bi bi-search me-2"></i>Keresés
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-7">
                            <div class="card shadow-sm border-0 h-100">
                                <div class="card-body">
                                    <h5 class="card-title mb-3 fw-bold">Elérhető időpontok</h5>
                                    <div class="list-group overflow-auto" style="max-height: 400px;">
                                        @for (slot of appoints; track slot.appointmentId) {
                                        <button type="button" (click)="setSelectedSlot(slot)"
                                            class="list-group-item list-group-item-action d-flex justify-content-between align-items-center mb-2 rounded border"
                                            [class.active]="selectedSlot === slot">
                                            <div>
                                                <span class="fw-bold fs-5 me-3">{{ slot.timeSlot | date:'HH:mm'
                                                    }}</span>
                                                <span class="small">Orvos: {{ searchDoctorNameByTaj(slot.doctorTaj)
                                                    }}</span>
                                            </div>
                                        </button>
                                        } @empty {
                                        <div class="text-center py-5 text-muted">
                                            <i class="bi bi-calendar-x fs-1 d-block"></i>
                                            <p>Nincs szabad időpont.</p>
                                        </div>
                                        }
                                    </div>
                                    <div class="mt-4 d-grid">
                                        <button class="btn btn-success btn-lg fw-bold" [disabled]="!selectedSlot"
                                            (click)="postAppointment()">
                                            <i class="bi bi-bookmark-check me-2"></i>Foglalás megerősítése
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                }
            </div>
        </div>
        <div class="tab-pane fade" id="schedule" role="tabpanel">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center py-3">
                    <span class="fw-bold">Munkabeosztás Kezelése</span>
                    <ul class="nav nav-pills card-header-pills" id="scheduleSubTab" role="tablist">
                        <li class="nav-item">
                            <button class="nav-link btn btn-outline-success btn-sm border-white text-white"
                                data-bs-toggle="tab" data-bs-target="#my-schedule" (click)="switchBetweenWorks('own')">
                                Saját napok
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link btn btn-outline-success btn-sm border-white text-white"
                                data-bs-toggle="tab" data-bs-target="#unassigned-schedule"
                                (click)="switchBetweenWorks('other')">
                                Felvehető napok
                            </button>
                        </li>
                    </ul>
                </div>


                <div class="card-body">
                    @if (!isBookingMode) {
                    <div class="row g-3 mb-4 justify-content-center border-bottom pb-4">
                        <div class="col-md-3 text-start">
                            <label class="form-label fw-bold small text-muted">Kezdő dátum</label>
                            <input type="date" class="form-control" [(ngModel)]="startDate" [min]="minStartDate"
                                [max]="endDate || ''">
                        </div>
                        <div class="col-md-5 text-start">
                            <label class="form-label fw-bold small text-muted">Záró dátum</label>
                            <div class="d-flex gap-2">
                                <input type="date" class="form-control" [(ngModel)]="endDate" [min]="startDate || ''"
                                    [max]="maxEndDate">
                                <button class="btn btn-outline-danger shadow-sm" (click)="resetField('date-to-date')">
                                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960"
                                        width="24px" fill="currentColor">
                                        <path
                                            d="M480-160q-134 0-227-93t-93-227q0-134 93-227t227-93q69 0 132 28.5T720-690v-110h80v280H520v-80h168q-32-56-87.5-88T480-720q-100 0-170 70t-70 170q0 100 70 170t170 70q77 0 139-44t87-116h84q-28 106-114 173t-196 67Z" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button class="btn btn-primary w-100 shadow-sm" [disabled]="!startDate || !endDate"
                                (click)="onWorkSearch()">Listázás</button>
                        </div>
                    </div>
                    }
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="my-schedule">
                            <h6 class="text-muted mb-3 italic small text-uppercase">
                                <i class="bi bi-person-check me-2"></i>Saját ledolgozott és vállalt napok
                            </h6>

                            <div class="list-group list-group-flush shadow-sm rounded border">
                                @for (w of works; track w.workDay) {
                                <div class="list-group-item p-0 border-bottom">
                                    <div class="d-flex justify-content-between align-items-center p-3">

                                        <div class="d-flex align-items-center gap-3">
                                            <span class="badge bg-info px-3 py-2 fs-6 shadow-sm">
                                                <i class="bi bi-calendar3 me-1"></i>
                                                {{ w.workDay }}
                                            </span>
                                            <span class="text-muted small">
                                                <strong class="text-dark">Doktor TAJ:</strong> {{ w.doctor?.taj || 'N/A'
                                                }}
                                            </span>
                                        </div>

                                        <div class="d-flex align-items-center gap-2">
                                            @if (w.workDay > today) {
                                            <span class="badge bg-warning px-3 py-2 fs-6 shadow-sm">Vállalt</span>
                                            <button
                                                class="btn btn-sm btn-outline-secondary ms-2 shadow-sm d-flex align-items-center gap-1"
                                                (click)="selectWork(w)">
                                                <i class="bi bi-arrow-left-right"></i> Csere
                                            </button>
                                            } @else if(w.assistant?.taj == appService.getTaj()) {
                                            <span class="badge bg-success px-3 py-2 fs-6 shadow-sm">
                                                <i class="bi bi-check2-circle me-1"></i> Teljesítve
                                            </span>
                                            }

                                            @if (work?.workId === w.workId) {
                                            <i class="bi bi-chevron-up text-primary ms-1"></i>
                                            }
                                        </div>
                                    </div>

                                    @if (work?.workId === w.workId) {
                                    <div class="p-4 bg-light border-top animate__animated animate__fadeIn">
                                        <div class="card border-0 shadow-sm mt-3">
                                            <div class="card-header bg-white py-2">
                                                <small class="fw-bold text-muted text-uppercase">Átadás közvetlenül
                                                    kollégának:</small>
                                            </div>
                                            <div class="list-group list-group-flush overflow-auto"
                                                style="max-height: 200px;">
                                                @for (ass of assistants; track ass.taj) {
                                                @if (ass.taj !== appService.getTaj()) {
                                                <div
                                                    class="list-group-item d-flex justify-content-between align-items-center py-2 bg-transparent">
                                                    <div class="small">
                                                        <span class="fw-bold text-dark">{{ ass.lastName }} {{
                                                            ass.firstName }}</span>
                                                        <span class="text-muted ms-2">(TAJ: {{ ass.taj }})</span>
                                                    </div>
                                                    <button class="btn btn-sm btn-outline-primary py-0 px-2"
                                                        (click)="changeAssistant(w,ass)">
                                                        <i class="bi bi-person-plus-fill me-1"></i> Átadás
                                                    </button>
                                                </div>
                                                }
                                                } @empty {
                                                <div class="list-group-item small text-muted text-center">Nincs elérhető
                                                    asszisztens.</div>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                    }
                                </div>
                                } @empty {
                                <div class="text-center py-5 text-muted bg-white">
                                    <i class="bi bi-calendar2-x fs-1 d-block mb-2"></i>
                                    <p>Nincsenek rögzített saját napjai.</p>
                                </div>
                                }
                            </div>
                        </div>

                        <div class="tab-pane fade" id="unassigned-schedule">
                            <h6 class="text-muted mb-3 italic small text-uppercase">
                                <i class="bi bi-exclamation-triangle me-2"></i>Asszisztensre váró napok
                            </h6>
                            <div class="list-group">
                                @for (w of works; track w.workDay) {
                                <div class="list-group-item d-flex justify-content-between align-items-center py-3">
                                    <div>
                                        <span class="fw-bold me-2">{{ w.workDay }}</span>
                                    </div>

                                    <div class="btn-group shadow-sm">
                                        <button class="btn btn-outline-success" title="Munkára jelentkezés"
                                            (click)="assign(w)">
                                            <svg xmlns="http://www.w3.org/2000/svg" height="24px"
                                                viewBox="0 -960 960 960" width="24px" fill="currentColor">
                                                <path
                                                    d="M200-120v-640q0-33 23.5-56.5T280-840h240v80H280v518l200-86 200 86v-278h80v400L480-240 200-120Zm80-640h240-240Zm400 160v-80h-80v-80h80v-80h80v80h80v80h-80v80h-80Z" />
                                            </svg>
                                        </button>
                                    </div>
                                </div>

                                } @empty {
                                <div class="text-center p-5 text-muted small">Minden napra van asszisztens.</div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>