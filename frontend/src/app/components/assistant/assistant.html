<div class="container-fluid py-4">
    <h2 class="mb-4 text-primary fw-bold text-center">Asszisztens Vezérlőpult</h2>

    <ul class="nav nav-pills nav-fill mb-4 shadow-sm p-2 bg-white rounded border" id="doctorTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active py-3" id="patients-tab" data-bs-toggle="tab" data-bs-target="#patients"
                type="button" (click)="navigateToPatient()">
                <i class="bi bi-people-fill me-2"></i>Betegek Adatai
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link py-3" id="appointments-tab" data-bs-toggle="tab" data-bs-target="#appointments"
                type="button" (click)="navigateToAppoints()">
                <i class="bi bi-calendar-check me-2"></i>Betegek Időpontjai
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link py-3" id="doctors-tab" data-bs-toggle="tab" data-bs-target="#doctors" type="button">
                <i class="bi bi-person-badge me-2"></i>Orvos választása
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link py-3" id="schedule-tab" data-bs-toggle="tab" data-bs-target="#schedule"
                type="button">
                <i class="bi bi-clock-history me-2"></i>Munkabeosztás
            </button>
        </li>
    </ul>

    <div class="tab-content" id="assistantTabContent">

        <div class="tab-pane fade show active text-center" id="patients" role="tabpanel">
            <div class="row g-3">
                <div class="col-lg-4">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-header bg-primary text-white fw-bold">Beteg Kereső</div>
                        <div class="card-body">
                            <input type="text" class="form-control mb-3" placeholder="Név vagy TAJ szám alapján..."
                                [(ngModel)]="filter" (input)="filterPatients()">
                            <div class="list-group overflow-auto" style="max-height: 500px;">
                                @for (p of filteredPatients; track p.taj) {
                                <button class="list-group-item list-group-item-action text-start"
                                    [class.active]="patient === p" (click)="selectPatient(p,false)">
                                    <h6 class="mb-1 fw-bold">{{p.firstName}} {{p.lastName}}</h6>
                                    <small [class.text-white]="patient === p" [class.text-muted]="patient !== p">
                                        TAJ: {{p.taj}}
                                    </small>
                                </button>
                                }
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-8">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-header bg-primary text-white">Beteg Részletes Adatai</div>
                        <div class="card-body text-start">
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <p><strong>Név:</strong> {{patient?.firstName}} {{patient?.lastName}}</p>
                                    <p><strong>Életkor:</strong> {{patient?.age}}</p>
                                </div>
                                <div class="col-md-6 text-md-end">
                                    <p><strong>TAJ:</strong> {{patient?.taj}}</p>
                                    <p><strong>Emal:</strong> {{patient?.email}}</p>
                                </div>
                            </div>
                            <hr>
                            <h6 class="fw-bold mb-3">Feltöltött Dokumentumok</h6>
                            <div class="document-container border p-3 rounded bg-light">
                                @for (file of patient?.personalDocImages; track file.dwnUrl) {
                                <div class="file-item mb-4 pb-3 border-bottom">

                                    @if (file.fileType === 'application/pdf') {
                                    <div class="pdf-box p-3 border rounded bg-light text-center">
                                        <h6 class="text-info">
                                            <i class="bi bi-file-earmark-pdf-fill"></i> {{ file.fileName }}
                                        </h6>
                                        <button (click)="this.appService.downloadPdf(file)"
                                            class="btn btn-outline-info btn-sm">
                                            <i class="bi bi-eye"></i> Megnyitás / Letöltés
                                        </button>
                                    </div>
                                    }
                                    @else if (file.fileType.includes('image')) {
                                    <div class="image-viewer text-center">
                                        <h6 class="text-primary">
                                            <i class="bi bi-image-fill"></i>{{ file.fileName }}
                                        </h6>
                                        <img [src]="'data:' + file.fileType + ';base64,' + file.base64Data"
                                            class="img-fluid">
                                    </div>
                                    }
                                    @else {
                                    <div class="alert alert-info d-flex align-items-center">
                                        <i class="bi bi-info-circle-fill me-2"></i>
                                        <div>
                                            <strong>{{ file.fileName }}</strong> ({{ file.fileType }})
                                            nem jeleníthető meg közvetlenül.
                                            <br>
                                            <a [href]="file.dwnUrl" target="_blank" class="btn btn-sm btn-primary mt-2">
                                                Fájl megnyitása / Letöltése
                                            </a>
                                        </div>
                                    </div>
                                    }

                                </div>
                                } @empty {
                                <div class="text-center py-4 text-muted">
                                    <i class="bi bi-files fs-1 d-block mb-2"></i>
                                    <p>Ehhez az pácienshez nem tartoznak csatolt fájlok.</p>
                                </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="appointments" role="tabpanel">
            <div class="row g-3">
                <div class="col-lg-4">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-header bg-primary text-white fw-bold">Páciens választása</div>
                        <div class="card-body">
                            <input type="text" class="form-control mb-3" placeholder="Név vagy TAJ..."
                                [(ngModel)]="filter" (input)="filterPatients()">
                            <div class="list-group overflow-auto" style="max-height: 600px;">
                                @for (p of filteredPatients; track p.taj) {
                                <button class="list-group-item list-group-item-action text-start"
                                    [class.active]="patient === p" (click)="selectPatient(p,true)">
                                    <h6 class="mb-1 fw-bold">{{p.firstName}} {{p.lastName}}</h6>
                                    <small [class.text-white]="patient === p">TAJ: {{p.taj}}</small>
                                </button>
                                }
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-8">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-header bg-primary text-white fw-bold">
                            {{ patient ? patient.lastName + ' időpontjai' : 'Válasszon pácienst!' }}
                        </div>
                        <div class="card-body p-0">
                            <div class="list-group list-group-flush">
                                @for (a of appoints; track a.id) {
                                <div class="list-group-item">
                                    <div class="d-flex justify-content-between align-items-center p-3 cursor-pointer border-bottom"
                                        (click)="selectAppo(a)" style="cursor: pointer;">

                                        <div class="d-flex align-items-center">
                                            <span class="text-muted">
                                                <strong class="text-dark">Doktor TAJ:</strong> {{a.doctorTaj}}
                                            </span>
                                        </div>

                                        <div class="d-flex align-items-center gap-3">
                                            <span class="badge bg-info px-3 py-2 fs-6 shadow-sm">
                                                <i class="bi bi-calendar3 me-1"></i>
                                                {{ a.timeSlot.toISOString().split('T')[0] }}
                                            </span>

                                            <span class="badge px-3 py-2 fs-6 shadow-sm"
                                                [ngClass]="'bg-' + appService.stausColorConverter(a.status)">
                                                {{ this.appService.statusConverter(a.status) }}
                                            </span>

                                            <i class="bi ms-2 fs-5 text-secondary"
                                                [class.bi-chevron-down]="appoId !== a.id"
                                                [class.bi-chevron-up]="appoId === a.id">
                                            </i>
                                        </div>
                                    </div>

                                    @if (appoId === a.id) {
                                    <div class="p-3 bg-light border-top mt-2 animate__animated animate__fadeIn">
                                        <div class="row">
                                            <div class="col-12 mb-3">
                                                <label class="fw-bold small text-muted d-block">Leírás / Panasz:</label>
                                                <p class="mb-0">{{ a.description || 'Nincs megadva leírás.' }}</p>
                                            </div>
                                            <div class="col-12">
                                                <label class="fw-bold small text-muted d-block mb-2">Csatolt
                                                    fájlok:</label>
                                                <div class="d-flex flex-wrap gap-2">
                                                    @for (file of a.files; track file.dwnUrl) {
                                                    @if (file.fileType === 'application/pdf') {
                                                    <button class="btn btn-sm btn-outline-secondary"
                                                        (click)="this.appService.downloadPdf(file)">

                                                        <i class="bi bi-file-earmark"></i> {{ file.fileName }}


                                                    </button>}@else if (file.fileType.includes('image')) {
                                                    <button
                                                        class="btn btn-sm btn-outline-secondary shadow-sm d-flex align-items-center gap-2"
                                                        (click)="this.appService.downloadPdf(file)"
                                                        [title]="file.fileName">

                                                        <img [src]="'data:' + file.fileType + ';base64,' + file.base64Data"
                                                            class="rounded border bg-white"
                                                            style="height: 24px; width: 24px; object-fit: cover;">

                                                        <span class="text-truncate" style="max-width: 150px;">
                                                            <i class="bi bi-image me-1"></i> {{ file.fileName }}
                                                        </span>
                                                    </button>
                                                    }

                                                    @else {
                                                    <button class="btn btn-sm btn-light border"
                                                        (click)="this.appService.downloadPdf(file)">
                                                        <i class="bi bi-file-earmark"></i> {{ file.fileName }}
                                                    </button>
                                                    }
                                                    } @empty {
                                                    <span class="text-muted small italic">Nincsenek fájlok.</span>
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    }
                                </div>
                                } @empty {
                                <div class="text-center py-5 text-muted">
                                    <i class="bi bi-calendar2-x fs-1 d-block mb-2"></i>
                                    <p>Nincsenek rögzített időpontok.</p>
                                </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="doctors" role="tabpanel">
            <div class="row g-3 text-center">
                <div class="col-lg-12">
                    <div class="card shadow-sm border-0">
                        <div class="card-header bg-primary text-white fw-bold">Asszisztens Keresése és Hozzárendelése
                        </div>
                        <div class="card-body">
                            <div class="row g-2 mb-4 justify-content-between align-items-start">

                                <div class="col-md-5 d-flex gap-2 align-items-start">
                                    <div style="flex-grow: 1;">
                                        <input type="date" class="form-row form-control" [(ngModel)]="dateFilter"
                                            #dateInput="ngModel" required [min]="today"
                                            [class.is-invalid]="isFilterSubmitted && !dateFilter">

                                        @if (isFilterSubmitted && !dateFilter) {
                                        <div class="invalid-feedback">
                                            A dátum megadása kötelező!
                                        </div>
                                        }
                                    </div>

                                    <button class="btn btn-outline-danger" type="button" (click)="resetField('date')">
                                        <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960"
                                            width="24px" fill="currentColor">
                                            <path
                                                d="M480-160q-134 0-227-93t-93-227q0-134 93-227t227-93q69 0 132 28.5T720-690v-110h80v280H520v-80h168q-32-56-87.5-88T480-720q-100 0-170 70t-70 170q0 100 70 170t170 70q77 0 139-44t87-116h84q-28 106-114 173t-196 67Z" />
                                        </svg>
                                    </button>

                                    <button class="btn btn-primary px-4" (click)="onDoctorSearch()">
                                        Szűrés
                                    </button>
                                </div>

                                <div class="col-md-4">
                                    <input type="text" class="form-control text-center" [(ngModel)]="filter"
                                        (input)="filterDoctors()" placeholder="Név vagy TAJ szám alapján...">
                                </div>
                            </div>

                            <div class="row row-cols-1 row-cols-md-3 g-4">
                                @for (d of filteredDoctors; track d.taj) {
                                <div class="col">
                                    <div class="card h-100 border-info border-2">
                                        <div class="card-body text-center">
                                            <div class="display-6 mb-2 text-info text-center"><i
                                                    class="bi bi-person-check-fill"></i></div>
                                            <h5 class="card-title fw-bold">{{ d.lastName }} {{ d.firstName }}</h5>
                                            <p class="card-text text-muted mb-1">TAJ: {{ d.taj }}</p>
                                            <span class="badge bg-success mb-3">Elérhető</span>
                                            <button class="btn btn-info w-100 text-white"
                                                (click)="selectDoctor(d)">Mellém rendelés</button>
                                        </div>
                                    </div>
                                </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="tab-pane fade" id="schedule" role="tabpanel">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-primary text-white fw-bold">Munkabeosztás Kezelése</div>
                <div class="card-body">
                    <div class="row g-3 mb-4 justify-content-center border-bottom pb-4">
                        <div class="col-md-3 text-start">
                            <label class="form-label fw-bold small text-muted">Kezdő dátum</label>
                            <input type="date" class="form-control" [(ngModel)]="startDate" [min]="minStartDate"
                                [max]="endDate || ''" [class.is-invalid]="isFilterSubmitted && !startDate">
                        </div>

                        <div class="col-md-5 text-start">
                            <label class="form-label fw-bold small text-muted">Záró dátum</label>
                            <div class="d-flex gap-2">
                                <input type="date" class="form-control" [(ngModel)]="endDate" [min]="startDate || ''"
                                    [max]="maxEndDate" [class.is-invalid]="isFilterSubmitted && !endDate">


                                <button class="btn btn-outline-danger shadow-sm" type="button"
                                    (click)="resetField('date-to-date')" title="Dátumok törlése">
                                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960"
                                        width="24px" fill="currentColor">
                                        <path
                                            d="M480-160q-134 0-227-93t-93-227q0-134 93-227t227-93q69 0 132 28.5T720-690v-110h80v280H520v-80h168q-32-56-87.5-88T480-720q-100 0-170 70t-70 170q0 100 70 170t170 70q77 0 139-44t87-116h84q-28 106-114 173t-196 67Z" />
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <div class="col-md-2 d-flex align-items-end">
                            <button class="btn btn-primary w-100 shadow-sm" (click)="onWorkSearch()">
                                Listázás
                            </button>
                        </div>
                    </div>

                    <div class="list-group">
                        @for (w of works; track w.workDay) {
                        <div class="list-group-item d-flex justify-content-between align-items-center py-3">
                            <div>
                                <span class="fw-bold me-2">{{ w.workDay }}</span>
                            </div>

                            <div class="btn-group shadow-sm">


                                @if (w.workDay > today) {
                                <button class="btn btn-outline-danger" title="Leadás" (click)="changeAssistant(w)">
                                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960"
                                        width="24px" fill="currentColor">
                                        <path
                                            d="M280-120q-33 0-56.5-23.5T200-200v-520h-40v-80h200v-40h240v40h200v80h-40v520q0 33-23.5 56.5T680-120H280Zm400-600H280v520h400v-520ZM360-280h80v-360h-80v360Zm160 0h80v-360h-80v360ZM280-720v520-520Z" />
                                    </svg>
                                </button>
                                }
                                @if (w.workDay < today && w.assistant) { <span
                                    class="badge bg-success d-flex align-items-center px-3">
                                    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960"
                                        width="24px" fill="currentColor">
                                        <path
                                            d="M480-80q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q65 0 123 19t107 53l-58 59q-38-24-81-37.5T480-800q-133 0-226.5 93.5T160-480q0 133 93.5 226.5T480-160q32 0 62-6t58-17l60 61q-41 20-86 31t-94 11Zm280-80v-120H640v-80h120v-120h80v120h120v80H840v120h-80ZM424-296 254-466l56-56 114 114 400-401 56 56-456 457Z" />
                                    </svg>
                                    </span>
                                    }
                            </div>
                        </div>
                        } @empty {
                        <div class="text-center p-5 text-muted">
                            <i class="bi bi-calendar-x fs-1 d-block"></i>
                            Nincs megjeleníthető időszak. Válasszon dátumot!
                        </div>
                        }
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>