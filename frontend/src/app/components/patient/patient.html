<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="text-primary mb-0">
      <i class="bi" [ngClass]="showProfile ? 'bi-person-circle' : 'bi-calendar-plus'"></i>
      {{ showProfile ? 'Saját adatok és leletek' : 'Időpont foglalás' }}
    </h2>
    
    <div class="form-check form-switch fs-5">
      <input class="form-check-input" type="checkbox" role="switch" id="viewToggle" [(ngModel)]="showProfile" (change)="onSwitch()">
      <label class="form-check-label small text-muted" for="viewToggle">Profil nézet</label>
    </div>
  </div>

  @if (!showProfile) {
  <div class="row g-4">
    <div class="col-lg-4">
      <div class="card shadow-sm border-0">
        <div class="card-header bg-primary text-white">Szűrési feltételek</div>
        <div class="card-body">

          <div class="mb-3">
            <label class="form-label fw-bold">Dátum kiválasztása</label>
            <div class="d-flex gap-1">
              <input type="date" class="form-control" [(ngModel)]="date" [min]="today" (focus)="missingDate = false" (change)="missingDate = false">
              <button class="btn btn-outline-danger" type="button" (click)="resetField('date')">
                <i class="bi bi-x-lg">
                  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                    fill="currentColor">
                    <path
                      d="M480-160q-134 0-227-93t-93-227q0-134 93-227t227-93q69 0 132 28.5T720-690v-110h80v280H520v-80h168q-32-56-87.5-88T480-720q-100 0-170 70t-70 170q0 100 70 170t170 70q77 0 139-44t87-116h84q-28 106-114 173t-196 67Z" />
                  </svg>
                </i>
              </button>
            </div>
            @if (missingDate) {
            <div class="text-danger small mt-1">Kérjük, válasszon dátumot a kereséshez!</div>
            }
          </div>

          <div class="mb-3">
            <label class="form-label fw-bold">Szekció (Osztály)</label>
            <div class="d-flex gap-1">
              <select class="form-select" [(ngModel)]="section" [disabled]="doctor !== null">
                <option selected hidden value="">Összes szekció</option>
                @for (sec of sections; track sec) {
                <option [value]="sec">{{ sec }}</option>
                }
              </select>
              <button class="btn btn-outline-danger" type="button" (click)="resetField('section')">
                <i class="bi bi-x-lg">
                  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                    fill="currentColor">
                    <path
                      d="M480-160q-134 0-227-93t-93-227q0-134 93-227t227-93q69 0 132 28.5T720-690v-110h80v280H520v-80h168q-32-56-87.5-88T480-720q-100 0-170 70t-70 170q0 100 70 170t170 70q77 0 139-44t87-116h84q-28 106-114 173t-196 67Z" />
                  </svg>
                </i>
              </button>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label fw-bold">Orvos</label>
            <div class="d-flex gap-1">
              <select class="form-select" [(ngModel)]="doctor" [disabled]="section !== null">
                <option selected hidden value="">Bármely orvos</option>
                @for (doc of doctors; track doc) {
                <option [ngValue]="doc">{{ doc.lastName }} {{ doc.firstName }}</option>
                }
              </select>
              <button class="btn btn-outline-danger" type="button" (click)="resetField('doctor')">
                <i class="bi bi-x-lg">
                  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                    fill= "currentColor">
                    <path
                      d="M480-160q-134 0-227-93t-93-227q0-134 93-227t227-93q69 0 132 28.5T720-690v-110h80v280H520v-80h168q-32-56-87.5-88T480-720q-100 0-170 70t-70 170q0 100 70 170t170 70q77 0 139-44t87-116h84q-28 106-114 173t-196 67Z" />
                  </svg>
                </i>
              </button>
            </div>
          </div>
          <div class="d-grid mt-4">
            <button class="btn btn-primary fw-bold" type="button" (click)="searchAppointments()">
              <i class="bi bi-search me-2"></i>Szabad időpontok keresése
            </button>
          </div>

        </div>
      </div>
    </div>

    <div class="col-lg-8">
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <h5 class="card-title mb-3">Elérhető időpontok</h5>

          <div class="list-group appointment-list">
            @for (a of appointments; track a.timeSlot) {
            <button type="button" (click)="setSelectedSlot(a)"
              class="list-group-item list-group-item-action d-flex justify-content-between align-items-center mb-2 rounded border">
              <div>
                <span class="fw-bold fs-5 me-3">{{ a.timeSlot | date:'HH:mm' }}</span>
                <span class="text-muted small">Orvos: {{ searchDoctorNameByTaj(a.doctorTaj) }}</span>
              </div>
            </button>
            } @empty {
            <div class="text-center py-5 text-muted">
              <i class="bi bi-calendar-x fs-1"></i>
              <p class="mt-2">Nincs elérhető időpont a választott feltételekkel.</p>
            </div>
            }
          </div>

          <div class="mt-4 d-grid">
            <button class="btn btn-success btn-lg fw-bold" [disabled]="!selectedSlot" type="button" (click)="postAppointment()">
              <i class="bi bi-bookmark-check me-2"></i>Foglalás megerősítése
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  }@else {
    <div class="row g-4 animate__animated animate__fadeIn">
      
      <div class="col-lg-4">
        <div class="card shadow-sm border-0 mb-4">
          <div class="card-header bg-primary text-white">Dokumentumok feltöltése</div>
          <div class="card-body">
            <p class="small text-muted">Formátumok (PDF, JPG, PNG).</p>
            <input type="file" class="form-control mb-3" (change)="onFilesSelected($event)" multiple accept=".pdf,.jpg,.png">
            <div class="d-grid">
              <button class="btn btn-outline-success btn-sm" (click)="onUpload()"><i class="bi bi-cloud-upload me-2"></i>Feltöltés indítása</button>
            </div>
          </div>
        </div>

        <div class="card shadow-sm border-0">
          <div class="card-header bg-primary text-white">Időpontok szűrése</div>
          <div class="card-body">
            <label class="form-label fw-bold">Státusz alapján</label>
            <select class="form-select" [(ngModel)]="statusFilter">
              <option selected value="" >Összes</option>
              <option value="DONE">Befejezett</option>
              <option value="LOCKED">Lefoglalt</option>
            </select>
          </div>
        </div>
      </div>

      <div class="col-lg-8">
        <div class="card shadow-sm border-0">
          <div class="card-body">
            <h5 class="card-title mb-3">Saját korábbi és jövőbeli időpontok</h5>
            <div class="table-responsive">
              <table class="table table-hover align-middle">
                <thead class="table-light">
                  <tr>
                    <th>Dátum</th>
                    <th>Orvos</th>
                    <th>Státusz</th>
                    <th class="text-center align-middle">Lemondás</th>
                  </tr>
                </thead>
                <tbody>
                  @for (my of appointments; track my) {
                    @if (!statusFilter || my.status === statusFilter) {
                      <tr>
                        <td>{{ my.timeSlot | date:'yyyy-MM-dd HH:mm' }} </td>
                        <td>{{ searchDoctorNameByTaj(my.doctorTaj) }}</td>
                        <td>{{ appService.statusConverter(my.status) }}</td>
                        <td class="text-center align-middle">
                          @if (my.status == "LOCKED") {
                          <button class="btn btn-sm btn-outline-danger" title="Lemondás" (click)="onCancelAppointment(my.id)">
                            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="currentColor">
                              <path
                                d="M280-440h400v-80H280v80ZM480-80q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-80q134 0 227-93t93-227q0-134-93-227t-227-93q-134 0-227 93t-93 227q0 134 93 227t227 93Zm0-320Z" />
                            </svg>
                          </button>
                        }
                        </td>
                        </tr>
                        }
                        } @empty {
                        <tr>
                      <td colspan="4" class="text-center py-4 text-muted">Nincs megjeleníthető időpont.</td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

    </div>
   }
</div>